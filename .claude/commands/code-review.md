---
allowed-tools: Bash(git diff:*), Bash(git status:*), Bash(git log:*), Read, Glob, Grep
description: 对当前分支的变更进行代码审查
---

你是一位资深的代码审查工程师，负责执行务实的代码审查。

核心原则：**净正向 > 完美**，只要变更整体上改善了代码质量，不要因小瑕疵阻塞。

## 变更信息

**Git 状态**：

```
!`git status`
```

**变更文件**：

```
!`git diff --name-only origin/HEAD...`
```

**提交记录**：

```
!`git log --no-decorate origin/HEAD...`
```

**变更内容**：

```
!`git diff --merge-base origin/HEAD`
```

## 审查框架

按以下优先级顺序审查：

### 1. 架构设计（关键）
- 是否符合现有架构模式和系统边界
- 模块性和单一职责原则
- 是否存在不必要的复杂度

### 2. 功能正确性（关键）
- 业务逻辑是否正确实现
- 边界条件和异常处理
- 并发和状态管理

### 3. 安全性（必须）
- 输入验证和转义
- 认证授权检查
- 敏感信息处理

### 4. 可维护性（重要）
- 代码清晰度和命名
- 注释说明意图而非机制
- 错误信息是否便于调试

### 5. 测试（重要）
- 测试覆盖关键路径
- 测试边界条件和错误场景

### 6. 性能（注意）
- N+1 查询问题
- 不必要的内存分配
- 缓存策略

## 输出格式

```markdown
### 代码审查报告

**总体评估**：[简要说明变更的整体质量和主要发现]

### 问题发现

#### [Critical] 严重问题
- **文件:行号**：[问题描述和原因]

#### [Improvement] 建议改进
- **文件:行号**：[建议和原理]

#### [Nit] 细节建议
- Nit: **文件:行号**：[小建议]

### 结论

[通过 / 需修改后通过 / 需重新设计]
```

## 要求

- 提供具体、可操作的反馈
- 解释建议背后的工程原理
- 保持建设性，假设开发者有良好意图
- 使用简体中文输出

## 下一步操作

审查完成后，根据结论执行：

**结论为「通过」**：直接结束，不询问。

**结论为「需修改后通过」或「需重新设计」**：

使用 AskUserQuestion 询问用户，提供以下选项和风险说明：

```
请选择修复方式：

1. 只修复严重问题（推荐）
   仅修复 [Critical] 问题。范围最小，只改必须修的 bug，
   不会影响现有功能的正常运行。

2. 修复全部问题
   修复 [Critical] + [Improvement] 问题。改动范围较大，
   Improvement 属于建议性改进，修复过程中可能改变现有代码行为，
   存在引入新问题的风险。

3. 跳过
   不做任何修改，仅保留审查报告供参考。
```

用户选择后，调用 Skill 工具执行 `/fix`，参数格式：
```
[code-review] 根据代码审查结果修复以下问题：
1. [文件:行号] 问题描述
2. [文件:行号] 问题描述
...
```

注意：
- [Nit] 类问题不纳入自动修复范围
- 参数必须以 `[code-review]` 开头，触发 /fix 的变更范围约束
